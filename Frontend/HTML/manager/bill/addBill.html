<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Bill</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: Arial, sans-serif;
    }

    .container {
      margin-top: 30px;
    }

    .table-container {
      margin-top: 20px;
    }

    .note-container {
      margin-top: 20px;
    }

    .submit-btn {
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div class="container">


    <div class="mb-3">
      <a href="../dashboard.html" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
      </a>
    </div>

    <h3 class="text-center">Add Student Bills</h3>

    <!-- Month Selection -->
    <div class="mb-3">
      <label for="monthSelect" class="form-label">Choose Month</label>
      <select class="form-select" id="monthSelect">
        <option value="January">January</option>
        <option value="February">February</option>
        <option value="March">March</option>
        <option value="April">April</option>
        <option value="May">May</option>
        <option value="June">June</option>
        <option value="July">July</option>
        <option value="August">August</option>
        <option value="September">September</option>
        <option value="October">October</option>
        <option value="November">November</option>
        <option value="December">December</option>
      </select>
    </div>


    <!-- Table -->
    <div class="table-container">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Name</th>
            <th>Account Number</th>
            <th>Total Bill</th>
            <th>Current Bill</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="studentTable">
          <!-- Rows will be dynamically populated here -->
        </tbody>
      </table>
    </div>

    <!-- Note Section -->
    <!-- <div class="note-container">
      <label for="note" class="form-label">Note for Students</label>
      <textarea class="form-control" id="note" rows="3" placeholder="Write a note for students..."></textarea>
    </div> -->

    <!-- Submit Button -->
    <!-- <button class="btn btn-primary submit-btn" id="submitBtn">Submit</button> -->
  </div>

  <script>
  // Fetch student details and populate the table
  async function fetchStudentDetails() {
    const token = localStorage.getItem("token");
    if (!token) {
      alert("You are not logged in. Redirecting to login page...");
      window.location.href = "../../login.html";
      return;
    }

    try {
      const response = await fetch('http://localhost:3000/api/mess', {
        method: 'GET',
        headers: {
          'Authorization': `${token}`
        }
      });

      if (response.ok) {
        const data = await response.json();
        const students = data.students;
        const studentTable = document.getElementById('studentTable');

        if (students.length > 0) {
          studentTable.innerHTML = '';
          students.forEach(student => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${student.name || 'N/A'}</td>
              <td>${student.messAccount || 'N/A'}</td>
              <td id="totalBill-${student.messAccount}">${student.currentMessBill || 0}</td>
              <td>
                <input type="number" class="form-control current-bill" id="currentBill-${student.messAccount}" placeholder="Enter current bill">
              </td>
              <td>
                <button class="btn btn-sm btn-success add-btn" data-id="${student._id}" data-account="${student.messAccount}" data-name="${student.name}">
                  Add
                </button>
              </td>
            `;
            studentTable.appendChild(row);
          });

          // Add event listeners to "Add" buttons
          document.querySelectorAll('.add-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
              const accountNumber = e.target.getAttribute('data-account');
              const studentId = e.target.getAttribute('data-id');
              const studentName = e.target.getAttribute('data-name');

              const currentBillInput = document.getElementById(`currentBill-${accountNumber}`);
              const totalBillCell = document.getElementById(`totalBill-${accountNumber}`);

              const currentBill = parseFloat(currentBillInput.value) || 0;
              const totalBill = parseFloat(totalBillCell.textContent) || 0;

              const newTotalBill = totalBill + currentBill;
              totalBillCell.textContent = newTotalBill;
              currentBillInput.value = ''; // clear input

              let month = document.getElementById("monthSelect").value;

              try {
                const res = await fetch(`http://localhost:3000/api/mess/${studentId}`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `${token}`
                  },
                  body: JSON.stringify({
                    studentId,
                    currentBill,
                    totalBill: newTotalBill,
                    name: studentName,
                    messAccount: accountNumber,
                    month
                  })
                });

                if (res.ok) {
                  alert(`Bill updated for ${studentName}`);
                } else {
                  const err = await res.json();
                  alert(`Failed: ${err.message || 'Update failed'}`);
                }
              } catch (error) {
                console.error('Error updating bill:', error);
                alert('An error occurred while updating bill.');
              }
            });
          });
        } else {
          studentTable.innerHTML = '<tr><td colspan="5" class="text-center">No students found.</td></tr>';
        }
      } else {
        const errorData = await response.json();
        alert(`Error: ${errorData.message || 'Failed to fetch student details'}`);
      }
    } catch (error) {
      console.error('Error fetching student details:', error);
      alert('An error occurred while fetching student details.');
    }
  }

  // Fetch student details on page load
  window.addEventListener('DOMContentLoaded', fetchStudentDetails);
</script>

</body>

</html>