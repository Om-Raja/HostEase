<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hostel Allotment - Caretaker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f5f7fb; font-family:Inter,Arial,Helvetica,sans-serif; padding:24px; }
    .table-wrap { background:#fff; padding:16px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .small-note { font-size:0.9rem; color:#6b7280; }
    .assigned { background:#e6ffed; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="m-0">Hostel Allotment Requests</h4>
      <div>
        <button id="refreshBtn" class="btn btn-light btn-sm">Refresh</button>
      </div>
    </div>

    <div class="table-wrap">
      <div class="table-responsive">
        <table class="table table-hover align-middle" id="requestsTable">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>CRN</th>
              <th>URN</th>
              <th>Mobile</th>
              <th>Branch</th>
              <th>CGPA</th>
              <th>Preferences</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="requestsBody">
            <!-- rows -->
          </tbody>
        </table>
      </div>
      <div id="msg" class="mt-2 small-note"></div>
    </div>
  </div>

  <!-- Assign modal -->
  <div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Assign Room</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="assignInfo" class="mb-2"></div>
          <label class="form-label">Choose from preferences or enter room</label>
          <select id="prefSelect" class="form-select mb-2"></select>
          <input id="customRoom" class="form-control" placeholder="Or type room to assign (optional)">
          <div id="assignAlert" class="mt-2"></div>
        </div>
        <div class="modal-footer">
          <button id="confirmAssignBtn" type="button" class="btn btn-primary">Assign</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

<script>
const requestsBody = document.getElementById('requestsBody');
const msg = document.getElementById('msg');
const refreshBtn = document.getElementById('refreshBtn');

let currentRequests = [];
let currentRequestId = null;
let currentPreferences = [];

async function fetchRequests() {
  msg.textContent = 'Loading...';
  try {
    const token = localStorage.getItem('token');
    const res = await fetch('http://localhost:3000/api/requests', {
      method: 'GET',
      headers: {
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      }
    });
    if (!res.ok) {
      const e = await res.json().catch(()=>({message:'failed'}));
      throw new Error(e.message || 'Failed to fetch');
    }
    const data = await res.json();
    currentRequests = Array.isArray(data) ? data : (data.requests || []);
    renderTable();
    msg.textContent = '';
  } catch (err) {
    console.error(err);
    msg.textContent = 'Error loading requests.';
  }
}

function renderTable(){
  requestsBody.innerHTML = '';
  if (!currentRequests.length) {
    requestsBody.innerHTML = '<tr><td colspan="8" class="text-center">No requests found</td></tr>';
    return;
  }
  currentRequests.forEach(req => {
    const tr = document.createElement('tr');
    if (req.assigned) tr.classList.add('assigned');
    tr.innerHTML = `
      <td>${req.name || 'N/A'}</td>
      <td>${req.crn || 'N/A'}</td>
      <td>${req.urn || 'N/A'}</td>
      <td>${req.mobile || 'N/A'}</td>
      <td>${req.branch || 'N/A'}</td>
      <td>${req.cgpa ?? 'N/A'}</td>
      <td>${(req.preferences || []).join(', ')}</td>
      <td>
        ${req.assigned ? `<span class="badge bg-success">Assigned: ${req.assignedRoom}</span>` : `<button class="btn btn-sm btn-primary assign-btn" data-id="${req._id}">Assign</button>`}
      </td>
    `;
    requestsBody.appendChild(tr);
  });

  // attach listeners
  document.querySelectorAll('.assign-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = e.currentTarget.dataset.id;
      openAssignModal(id);
    });
  });
}

function openAssignModal(requestId){
  const req = currentRequests.find(r=>r._id===requestId);
  if(!req) return;
  currentRequestId = requestId;
  currentPreferences = req.preferences || [];
  document.getElementById('assignInfo').innerHTML = `<strong>${req.name}</strong> â€” Preferences: ${currentPreferences.join(', ')}`;
  const prefSelect = document.getElementById('prefSelect');
  prefSelect.innerHTML = '';
  const noneOpt = document.createElement('option');
  noneOpt.value = '';
  noneOpt.text = '-- choose preference --';
  prefSelect.appendChild(noneOpt);
  currentPreferences.forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p;
    opt.text = p;
    prefSelect.appendChild(opt);
  });
  document.getElementById('customRoom').value = '';
  document.getElementById('assignAlert').innerHTML = '';
  const modalEl = new bootstrap.Modal(document.getElementById('assignModal'));
  modalEl.show();
}

document.getElementById('confirmAssignBtn').addEventListener('click', async ()=>{
  const chosen = document.getElementById('prefSelect').value.trim();
  const custom = document.getElementById('customRoom').value.trim();
  const assignAlert = document.getElementById('assignAlert');
  assignAlert.innerHTML = '';

  const assignedRoom = custom || chosen;
  if (!assignedRoom) {
    assignAlert.innerHTML = '<div class="alert alert-danger p-2">Select or enter a room to assign.</div>';
    return;
  }

  try {
    const token = localStorage.getItem('token');
    const res = await fetch('http://localhost:3000/api/room/assign', {
      method: 'POST',
      headers: {
        'Content-Type':'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      },
      body: JSON.stringify({ requestId: currentRequestId, assignedRoom })
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>({message:'failed'}));
      throw new Error(err.message || 'Assign failed');
    }
    // close modal and refresh
    const modal = bootstrap.Modal.getInstance(document.getElementById('assignModal'));
    modal.hide();
    await fetchRequests();
  } catch (err) {
    console.error(err);
    document.getElementById('assignAlert').innerHTML = `<div class="alert alert-danger p-2">${err.message}</div>`;
  }
});

refreshBtn.addEventListener('click', fetchRequests);

// initial load
fetchRequests();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>